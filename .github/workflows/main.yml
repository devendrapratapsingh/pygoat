name: CI
on: [push]
jobs:
   sast_scan:
       name: Bandit scan
       runs-on: ubuntu-latest
       steps:
         - name: checkout code
           uses: actions/checkout@v4

         - name: setup python
           uses: actions/setup-python@v5
           with:
             python-version: 3.11

         - name: install bandit
           run: pip install bandit[sarif]

         - name: run bandit scan
           run: bandit -ll -ii -r . -f sarif -o bandit-report.sarif

         - name: upload SARIF to GitHub Security
           uses: github/codeql-action/upload-sarif@v3
           if: always()
           with:
             sarif_file: bandit-report.sarif

         - name: upload artifacts
           uses: actions/upload-artifact@v4
           if: always()
           with:
             name: bandit-findings
             path: bandit-report.sarif

   image_scan:
     name: build and scan the image
     runs-on: ubuntu-22.04
     #needs: sast_scan
     steps:
         - name: checkout code
           uses: actions/checkout@v4

         - name: Install Docker 20.10.7
           run: |
             # Remove existing Docker packages completely
             sudo apt-get remove -y docker-ce docker-ce-cli docker.io containerd.io docker-scan-plugin docker-buildx-plugin || true
             sudo apt-get autoremove -y
             
             # Install prerequisites
             sudo apt-get update
             sudo apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release
             
             # Add Docker's official GPG key
             sudo rm -f /usr/share/keyrings/docker-archive-keyring.gpg
             curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
             
             # Set up stable repository for Ubuntu 20.04 (focal)
             echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu focal stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
             
             # Install Docker 20.10.7 with --allow-downgrades
             sudo apt-get update
             sudo apt-cache madison docker-ce | grep 20.10.7
             sudo apt-get install -y --allow-downgrades docker-ce=5:20.10.7~3-0~ubuntu-focal docker-ce-cli=5:20.10.7~3-0~ubuntu-focal containerd.io
             
             # Verify installation
             docker --version
             sudo systemctl restart docker
             sudo docker run hello-world

         - name: build image
           run: docker build -f Dockerfile -t myapp:latest .

#         - name: docker scout scan
#           env:
#             DOCKER_USER: ${{ secrets.REPO_USER }}
#             DOCKER_PWD: ${{ secrets.REPO_PWD }}
#           run: |
#             curl -sSfL https://raw.githubusercontent.com/docker/scout-cli/main/install.sh -o install-scout.sh
#             sh install-scout.sh
#             printf '%s\n' "$DOCKER_PWD" | docker login -u "$DOCKER_USER" --password-stdin
#             docker scout quickview
#             docker scout cves

         - name: docker scout
           uses: docker/scout-action@v1.18.2
           with:
                 dockerhub-user: ${{ secrets.REPO_USER }}
                 dockerhub-password: ${{ secrets.REPO_PWD }}
                 command: quickview,cves
                 only-severities: "Critical,High"
                 sarif-file: scout-report.sarif


         - name: upload artifacts
           uses: actions/upload-artifact@v4
           if: always()
           with:
             name: scout-findings
             path: scout-report.sarif

        
  
